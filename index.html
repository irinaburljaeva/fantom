<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–®–ê–ì–ê–ô –î–û–ú–ê ‚Äî –ù–∞–π–¥–∏ –ü—Ä–∏–≤–∏–¥–µ–Ω–∏–µ –û—Å–µ–Ω–Ω–µ–≥–æ –õ–∞–≥–µ—Ä—è</title>
<style>
:root{--brand:#e24a27;--text:#222;--bg:#fff;--panel:#f7f8f9}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
button{cursor:pointer;background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 18px;font-size:1rem;transition:.2s}
button:hover{box-shadow:0 4px 14px rgba(226,74,39,.3);transform:translateY(-1px)}
button[aria-disabled="true"]{opacity:.6;cursor:default;box-shadow:none;transform:none}

body.prestart #hud, body.prestart #gameWrap{display:none!important}
body.started #introWrap{display:none!important}

/* Intro */
.intro-wrap{max-width:960px;margin:0 auto;padding:20px}
.intro{position:relative;overflow:hidden;border-radius:18px;background:#f1f2f3;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.intro figure{margin:0;position:absolute;inset:0}
.intro img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .3s}
.intro img.ready{opacity:1}
.intro .panel{position:relative;padding:24px;background:rgba(255,255,255,.86);backdrop-filter:blur(6px)}
.intro h1{margin:0 0 8px;font-size:1.8rem}
.intro p{margin:10px 0;line-height:1.45}
blockquote.msg{margin:14px 0;padding:10px 14px;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.08);box-shadow:0 4px 12px rgba(0,0,0,.06)}
.msg-head{display:flex;align-items:center;gap:8px;font-size:.9em;color:#555;margin-bottom:4px}
.msg-avatar{width:22px;height:22px;display:grid;place-items:center;border-radius:50%;background:#f6f7f9}
.msg-author{font-weight:600;color:#222}
.msg-dot{opacity:.6}
.msg-time{opacity:.6}
blockquote.msg p{margin:0;font-size:.97em}

/* HUD / Game */
.hud{position:sticky;top:0;background:#fff;border-bottom:1px solid rgba(0,0,0,.08);display:flex;align-items:center;gap:10px;padding:8px 14px;z-index:10}
.badge{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:20px;padding:6px 10px}
.progress{flex:1;height:6px;background:#e0e0e0;border-radius:10px;overflow:hidden}
.bar{height:100%;width:0;background:var(--brand);transition:width .3s}

.play-wrap{max-width:1100px;margin:20px auto;display:flex;flex-wrap:wrap;gap:20px;padding:0 14px}
.stage-wrap{flex:1 1 650px;min-width:320px}
.stage{position:relative;aspect-ratio:16/10;border-radius:16px;overflow:hidden;background:#ddd;box-shadow:0 10px 30px rgba(0,0,0,.1)}
.layer{position:absolute;inset:0}
#imgMain{position:absolute;will-change:transform;user-select:none;-webkit-user-drag:none}
.pill{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:8px 12px;font-size:.95rem}
.dock{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}

/* magnifier (canvas) */
.lens-canvas{
  position:absolute; top:0; left:0;
  width:180px; height:180px;           /* –≤–∏–∑—É–∞–ª—å–Ω—ã–π –¥–∏–∞–º–µ—Ç—Ä –ª—É–ø—ã */
  border-radius:50%;
  border:3px solid rgba(0,0,0,.28);
  box-shadow:0 8px 24px rgba(0,0,0,.28);
  pointer-events:none;
  display:none; z-index:5; background:transparent;
}
.tool-btn{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,.12);padding:8px 12px;border-radius:10px}
.tool-btn[aria-pressed="true"]{border-color:var(--brand);box-shadow:0 0 0 2px rgba(226,74,39,.15)}

/* side panel */
.side{flex:0 0 340px;background:var(--panel);border-radius:16px;padding:16px;border:1px solid rgba(0,0,0,.06);box-shadow:0 8px 20px rgba(0,0,0,.1);display:none}
.side h3{margin:0 0 8px}
.side p{margin:0 0 10px}
.hint{background:#fff;border-radius:10px;border:1px dashed rgba(0,0,0,.2);padding:10px 12px;margin-bottom:10px}

.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:50}
.loader{position:absolute;inset:0;display:none;place-items:center;background:rgba(255,255,255,.4);z-index:4}
.ring{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.1);border-top-color:var(--brand);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* celebrate */
.celebrate{position:absolute;inset:0;display:none;place-items:center;pointer-events:none}
.heart{font-size:60px;opacity:0;transform:scale(.7);animation:pop 1.2s ease forwards}
@keyframes pop{0%{opacity:0;transform:scale(.7) translateY(20px)}50%{opacity:1;transform:scale(1) translateY(-4px)}100%{opacity:0;transform:scale(1.15) translateY(-24px)}}

.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);z-index:20}
.card{background:#fff;border-radius:14px;padding:16px;width:min(520px,92vw)}
.actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
@media(max-width:700px){.side{flex:1 1 100%}}
</style>
</head>
<body class="prestart">

<!-- –ò–Ω—Ç—Ä–æ -->
<div class="intro-wrap" id="introWrap">
  <section id="intro" class="intro">
    <figure><img id="introImg" alt="–û—Å–µ–Ω–Ω–∏–π –ª–µ—Å"></figure>
    <div class="panel">
      <h1>–û—Å–µ–Ω–Ω–∏–π –ª–∞–≥–µ—Ä—å ¬´–®–ê–ì–ê–ô –î–û–ú–ê¬ª</h1>
      <p>–í –ª–∞–≥–µ—Ä–µ –®–ê–ì–ê–ô –î–û–ú–ê –æ—Å–µ–Ω—å—é –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á—É–¥–µ—Å–∞. –û–¥–Ω–∞–∂–¥—ã –≤ —á–∞—Ç –ø—Ä–∏—à–ª–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:</p>
      <blockquote class="msg">
        <div class="msg-head">
          <span class="msg-avatar" aria-hidden="true">üëª</span>
          <span class="msg-author">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
          <span class="msg-dot">‚Ä¢</span>
          <time class="msg-time">—Å–µ–≥–æ–¥–Ω—è</time>
        </div>
        <p>–ü—Ä–∏–≤–µ—Ç! –Ø –∂–∏–≤—É –∑–¥–µ—Å—å —Å –ø—Ä–æ—à–ª–æ–≥–æ —Å–µ–∑–æ–Ω–∞. –Ø –ª—é–±–ª—é —á–∞–π —Å –æ–±–ª–µ–ø–∏—Ö–æ–π, –æ—Å–µ–Ω–Ω–∏–µ –ª–∏—Å—Ç—å—è –∏ —à–∞–≥–∏ –ø–æ —É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–æ—Å–µ. –ê –µ—â—ë —è –Ω–µ–º–Ω–æ–∂–∫–æ‚Ä¶ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π.</p>
      </blockquote>
      <p>–¢–∞–∫ –≤—Å–µ —É–∑–Ω–∞–ª–∏ –ø—Ä–æ –ü—Ä–∏–≤–∏–¥–µ–Ω–∏–µ –û—Å–µ–Ω–Ω–µ–≥–æ –õ–∞–≥–µ—Ä—è ‚Äî –®–∞–≥—É–Ω—é. –û–Ω –Ω–µ –ø—É–≥–∞–µ—Ç, –∞ –ø–æ–º–æ–≥–∞–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è, –≥—Ä–µ—Ç—å—Å—è –∏ –Ω–µ –≥—Ä—É—Å—Ç–∏—Ç—å. –ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è: –∑–∞ –Ω–µ–¥–µ–ª—é –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –®–∞–≥—É–Ω—é –Ω–∞ –≤—Å–µ—Ö –ª–æ–∫–∞—Ü–∏—è—Ö –ª–∞–≥–µ—Ä—è –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ–≥–æ –∑–∞–¥–∞–Ω–∏—è.</p>
      <footer><button id="startBtn" type="button">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button></footer>
    </div>
  </section>
</div>

<!-- HUD -->
<header class="hud" id="hud">
  <div class="badge">–£—Ä–æ–≤–µ–Ω—å: <span id="levelLabel" class="brand">1/5</span></div>
  <div class="progress"><div id="progressBar" class="bar"></div></div>
</header>

<!-- –ò–≥—Ä–∞ -->
<section class="play-wrap" id="gameWrap">
  <div class="stage-wrap">
    <div id="stage" class="stage">
      <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è (—Ç–æ—á–Ω—ã–π cover) -->
      <img id="imgMain" alt="" draggable="false" />
      <!-- –≠—Ñ—Ñ–µ–∫—Ç—ã -->
      <div id="celebrate" class="celebrate"><div class="heart">üíñ</div></div>
      <div id="loader" class="loader"><div class="ring"></div></div>
      <!-- –õ–£–ü–ê (canvas) -->
      <canvas id="lens" class="lens-canvas" width="180" height="180" aria-hidden="true"></canvas>
    </div>
    <div class="dock">
      <button id="zoomBtn" type="button" class="tool-btn" aria-pressed="false" title="–õ—É–ø–∞">üîç –õ—É–ø–∞</button>
      <div id="levelTask" class="pill">–ù–∞–π–¥–∏ –®–∞–≥—É–Ω—é –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ</div>
      <div class="pill">–û—á–∫–∏: <span id="score">0</span></div>
    </div>
  </div>

  <aside id="sidePanel" class="side">
    <h3>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!</h3>
    <p>–ü–æ—Ä–∞ —Ä–∞–∑–æ–≥–Ω–∞—Ç—å —Å–æ–Ω. –Ø –ª—é–±–ª—é –Ω–∞—á–∏–Ω–∞—Ç—å –¥–µ–Ω—å —Å –ª—ë–≥–∫–∏—Ö —à–∞–≥–æ–≤ ‚Äî –∞ —Ç—ã?</p>
    <div class="hint">
      <div id="hintText">üéØ <b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ø—Ä–æ–π—Ç–∏ 300 —à–∞–≥–æ–≤ –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Ä–∞–∑–º–∏–Ω–∫—É –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.</div>
    </div>
    <div class="btns">
      <button id="reportBtn" type="button">–û—Ç—á–∏—Ç–∞—Ç—å—Å—è</button>
      <button id="nextBtn" type="button" aria-disabled="true" style="background:#26a269">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    </div>
  </aside>
</section>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ç—á—ë—Ç–∞ -->
<section id="reportModal" class="modal">
  <div class="card">
    <h4>–û—Ç—á—ë—Ç –ø–æ –∑–∞–¥–∞–Ω–∏—é</h4>
    <div id="reportOptions">
      <label><input type="radio" name="task" value="steps300"> –Ø –ø—Ä–æ—à—ë–ª(–ª–∞) 300 —à–∞–≥–æ–≤</label><br/>
      <label><input type="radio" name="task" value="warmup2m"> –Ø —Å–¥–µ–ª–∞–ª(–∞) –∑–∞—Ä—è–¥–∫—É 2 –º–∏–Ω—É—Ç—ã</label>
    </div>
    <div class="actions">
      <button id="cancelReport" type="button" style="background:#e7eaee;color:#222">–û—Ç–º–µ–Ω–∞</button>
      <button id="submitReport" type="button">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>
</section>

<div id="toast" class="toast"></div>

<script>
/* ===== –ê–°–°–ï–¢–´ ===== */
const ASSETS = {
  start:'start.jpg',
  lvl1:'lvl1.jpg',       lvl1found:'lvl1found.jpg',
  lvl2:'lvl2.jpg',       lvl2found:'lvl2found.jpg',
  lvl3:'lvl3.jpg',       lvl3found:'lvl3found.jpg',
  lvl4:'lvl4.jpg',       lvl4found:'lvl4found.jpg',
  lvl5:'lvl5.jpg',       lvl5found:'lvl5found.jpg'
};

/* ===== –ö–û–ù–§–ò–ì –£–†–û–í–ù–ï–ô ===== */
const GAME_CONFIG = {
  levels: [
    { // 1
      bg: ASSETS.lvl1, bgFound: ASSETS.lvl1found,
      hotspot: { x: 97.25, y: 53.8, w: 3.4, h: 11.5 },
      introTitle: '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!',
      introText: '–ü–æ—Ä–∞ —Ä–∞–∑–æ–≥–Ω–∞—Ç—å —Å–æ–Ω. –Ø –ª—é–±–ª—é –Ω–∞—á–∏–Ω–∞—Ç—å –¥–µ–Ω—å —Å –ª—ë–≥–∫–∏—Ö —à–∞–≥–æ–≤ ‚Äî –∞ —Ç—ã?',
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏–µ: –ø—Ä–æ–π—Ç–∏ 300 —à–∞–≥–æ–≤ –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Ä–∞–∑–º–∏–Ω–∫—É –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.',
      options: [['steps300','–Ø –ø—Ä–æ—à—ë–ª(–ª–∞) 300 —à–∞–≥–æ–≤'],['warmup2m','–Ø —Å–¥–µ–ª–∞–ª(–∞) –∑–∞—Ä—è–¥–∫—É 2 –º–∏–Ω—É—Ç—ã']]
    },
    { // 2 ‚Äî —à–µ–∑–ª–æ–Ω–≥–∏
      bg: ASSETS.lvl2, bgPos: 'center', bgFound: ASSETS.lvl2found, bgFoundPos: 'center 60%',
      poly: [[20.65,80.12],[22.50,82.84],[20.80,87.27],[18.64,82.59]],
      introTitle: '–ú–∏–Ω—É—Ç–∫–∞ –æ—Ç–¥—ã—Ö–∞',
      introText: '–§—É—Ö‚Ä¶ –¥–∞–∂–µ –ø—Ä–∏–∑—Ä–∞–∫–∞–º –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö! –ò–Ω–æ–≥–¥–∞ —Å–∞–º–æ–µ –ø–æ–ª–µ–∑–Ω–æ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–µ–∂–∞—Ç—å –∏ –ø–æ—Å–ª—É—à–∞—Ç—å, –∫–∞–∫ —à—É—Ä—à–∞—Ç –ª–∏—Å—Ç—å—è. –ê –ø–æ—Ç–æ–º, –∫–æ–Ω–µ—á–Ω–æ, –Ω–µ–º–Ω–æ–≥–æ –ø–æ—à–∞–≥–∞—Ç—å ‚Äî —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–Ω—É—Ç—å',
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏–µ –¥–Ω—è: —Å–ø–æ–∫–æ–π–Ω–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ 10‚Äì15 –º–∏–Ω—É—Ç –∏–ª–∏ —Ä–∞–∑–º–∏–Ω–∫–∞ –¥–ª—è —Å–ø–∏–Ω—ã –∏ —à–µ–∏.',
      options: [['walk15','–°–ø–æ–∫–æ–π–Ω–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ 10‚Äì15 –º–∏–Ω—É—Ç'],['stretch','–†–∞–∑–º–∏–Ω–∫–∞ –¥–ª—è —Å–ø–∏–Ω—ã –∏ —à–µ–∏']]
    },
    { // 3 ‚Äî —Å—Ç–æ–ª–æ–≤–∞—è
      bg: ASSETS.lvl3, bgFound: ASSETS.lvl3found,
      hotspot: { x: 80, y: 70, w: 5, h: 9 },
      introTitle: '–ì–æ—Ä—è—á–∏–π –∫–∞–∫–∞–æ',
      introText: '–ì–æ—Ä—è—á–∏–π –∫–∞–∫–∞–æ –∏ –¥–µ–Ω—å —É–∂–µ —á—É—Ç—å-—á—É—Ç—å –ª—É—á—à–µ! –ê —á—Ç–æ–±—ã –æ–Ω —Å—Ç–∞–ª —Å–æ–≤—Å–µ–º –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ —à–∞–≥–æ–≤',
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏–µ: —Å–¥–µ–ª–∞—Ç—å 500 —à–∞–≥–æ–≤ –ø–æ–¥ –º—É–∑—ã–∫—É –∏–ª–∏ –ø–æ—à–∞–≥–∞—Ç—å –Ω–∞ –º–µ—Å—Ç–µ 1 –º–∏–Ω—É—Ç—É.',
      options: [['steps500','500 —à–∞–≥–æ–≤ –ø–æ–¥ –º—É–∑—ã–∫—É'],['march1m','–ü–æ—à–∞–≥–∞—Ç—å 1 –º–∏–Ω—É—Ç—É']]
    },
    { // 4 ‚Äî –∑–∞—Ä—è–¥–∫–∞
      bg: ASSETS.lvl4, bgFound: ASSETS.lvl4found, bgFoundPos: 'center 58%',
      poly: [[28.04,91.96],[30.05,93.68],[28.20,96.39],[26.96,94.18]],
      introTitle: '–í –∑–¥–æ—Ä–æ–≤–æ–º —Ç–µ–ª–µ ‚Äî –∑–¥–æ—Ä–æ–≤—ã–π –¥—É—Ö!',
      introText: '–î–∞–∂–µ –ø—Ä–∏–∑—Ä–∞–∫–∏ –¥–µ–ª–∞—é—Ç –∑–∞—Ä—è–¥–∫—É, –∞ –≤—ã? –£–∂–µ —Ä–∞–∑–º—è–ª–∏—Å—å?',
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏—è: 1) –∑–∞—Ä—è–¥–∫–∞ –æ—Ç –î–∏–º—ã –∏–ª–∏ 2) 5 –º–∏–Ω—É—Ç –º—è–≥–∫–æ–π —Ä–∞—Å—Ç—è–∂–∫–∏ –≤—Å–µ–≥–æ —Ç–µ–ª–∞.',
      options: [['dima_warmup','–ó–∞—Ä—è–¥–∫–∞ –æ—Ç –î–∏–º—ã'],['stretch5','5 –º–∏–Ω—É—Ç –º—è–≥–∫–æ–π —Ä–∞—Å—Ç—è–∂–∫–∏']]
    },
    { // 5 ‚Äî —Ñ–∏–Ω–∞–ª
      bg: ASSETS.lvl5, bgFound: ASSETS.lvl5found,
      poly: [[72.73,63.61],[74.27,67.80],[72.57,73.22],[71.03,67.80]],
      introTitle: '–§–∏–Ω–∞–ª! –®–∞–≥—É–Ω—è –Ω–∞–π–¥–µ–Ω',
      introText: '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –ª–æ–∫–∞—Ü–∏–∏ –ª–∞–≥–µ—Ä—è –∏ –Ω–∏ —Ä–∞–∑—É –Ω–µ –∏—Å–ø—É–≥–ª–∏—Å—å! –®–∞–≥—É–Ω—è –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç –∑–∞ –∫–æ–º–ø–∞–Ω–∏—é.',
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏–µ: 10 –º–∏–Ω—É—Ç –ø—Ä–æ–≥—É–ª–∫–∏ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ –∏–ª–∏ –ª—é–±–∏–º–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ü–µ–ª–∏–∫–æ–º.',
      options: [['walk10','–ü—Ä–æ–≥—É–ª–∫–∞ 10 –º–∏–Ω—É—Ç'],['favworkout','–õ—é–±–∏–º–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ü–µ–ª–∏–∫–æ–º']]
    }
  ]
};

/* ===== DOM ===== */
const $=s=>document.querySelector(s);
const introImg=$('#introImg'), startBtn=$('#startBtn'),
      stage=$('#stage'), imgMain=$('#imgMain');
const celebrate=$('#celebrate'), loader=$('#loader');
const sidePanel=$('#sidePanel'), levelTask=$('#levelTask');
const levelLabel=$('#levelLabel'), progressBar=$('#progressBar');
const reportBtn=$('#reportBtn'), nextBtn=$('#nextBtn'), toast=$('#toast');
const hintText=$('#hintText'), reportOptions=$('#reportOptions'), scoreEl=$('#score');
const reportModal=$('#reportModal'), cancelReport=$('#cancelReport'), submitReport=$('#submitReport');

/* magnifier DOM */
const zoomBtn=$('#zoomBtn'), lensCv=$('#lens'), lctx=lensCv.getContext('2d',{alpha:true});

/* ===== –°–û–°–¢–û–Ø–ù–ò–ï ===== */
let currentLevel = 0;
let state = { found:false, taskDone:false, score:0 };
let currentSrc = '', currentBgPos = 'center';
let naturalW = 0, naturalH = 0; // –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏
const LENS_D = 180, LENS_R = LENS_D/2; // –ª—É–ø–∞
const ZOOM = 2.2;

/* ===== –ü–†–ï–õ–û–ê–î + –õ–û–ê–î–ï–† ===== */
function preload(src){
  return new Promise((resolve)=>{
    const img=new Image();
    img.onload=()=>resolve({src,width:img.naturalWidth,height:img.naturalHeight});
    img.onerror=()=>resolve({src,width:0,height:0});
    img.src=src;
    if(img.complete) resolve({src,width:img.naturalWidth,height:img.naturalHeight});
  });
}
let loadSeq = 0;
function showLoader(seq){ if(seq !== loadSeq) return; loader.style.display = 'grid'; }
function hideLoader(seq){ if(seq !== loadSeq) return; requestAnimationFrame(()=>requestAnimationFrame(()=>{ loader.style.display = 'none'; })); }

/* ===== –£–¢–ò–õ–ò–¢–´ ===== */
function showToast(msg,t=1600){ toast.textContent=msg; toast.style.display='block'; clearTimeout(showToast.tid); showToast.tid=setTimeout(()=>toast.style.display='none',t); }
function clickPt(e){ const r=stage.getBoundingClientRect(); return { x:(e.clientX-r.left)/r.width*100, y:(e.clientY-r.top)/r.height*100, rect:r }; }
function inside(p,r){ return p.x>=r.x-r.w/2 && p.x<=r.x+r.w/2 && p.y>=r.y-r.h/2 && p.y<=r.y+r.h/2; }
function pointInPoly(pt, poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const [xi,yi]=poly[i],[xj,yj]=poly[j];
    const inter=((yi>pt.y)!==(yj>pt.y)) && (pt.x < (xj-xi)*(pt.y-yi)/((yj-yi)||1e-6) + xi);
    if(inter) inside=!inside;
  }
  return inside;
}
function updateHud(){
  const total = GAME_CONFIG.levels.length;
  levelLabel.textContent = `${currentLevel+1}/${total}`;
  const done = [...Array(total).keys()].filter(i => localStorage.getItem(`level_done_${i}`)==='1').length;
  progressBar.style.width = Math.round(done/total*100) + '%';
}

/* ===== –ò–ù–¢–†–û ===== */
preload(ASSETS.start).then(({src})=>{ introImg.src=src; introImg.onload=()=>introImg.classList.add('ready'); });

/* ===== background-position –ø–∞—Ä—Å–µ—Ä ===== */
function parseBgPos(pos){
  let x='50%', y='50%';
  if(typeof pos==='string'){
    const parts = pos.trim().split(/\s+/);
    if(parts.length===1){ x = parts[0]; } else { x = parts[0]; y = parts[1]; }
  }
  const map = {left:'0%', top:'0%', center:'50%', right:'100%', bottom:'100%'};
  x = map[x] || x; y = map[y] || y;
  const toF = v => (String(v).endsWith('%') ? parseFloat(v)/100 : 0.5);
  return {px:toF(x), py:toF(y)};
}

/* ===== cover-–≥–µ–æ–º–µ—Ç—Ä–∏—è + –ø–æ–∑–∏—Ü–∏—è –¥–ª—è IMG ===== */
function layoutCoverForImg(containerW, containerH, imgW, imgH, posStr){
  if(!imgW||!imgH) return {w:containerW,h:containerH,left:0,top:0};
  const {px,py} = parseBgPos(posStr||'50% 50%');
  const rC = containerW / containerH;
  const rI = imgW / imgH;
  let w,h;
  if(rC > rI){ w = containerW; h = w / rI; }
  else { h = containerH; w = h * rI; }
  const left = (containerW - w) * px;
  const top  = (containerH - h) * py;
  return {w,h,left,top};
}

/* ===== —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —É—Ä–æ–≤–Ω—è ===== */
function setImage(url, pos='center'){
  currentSrc = url; currentBgPos = pos;
  imgMain.style.opacity='0';
  imgMain.src = url;
  imgMain.onload = () => {
    naturalW = imgMain.naturalWidth;
    naturalH = imgMain.naturalHeight;
    // –≤—ã—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ—á–Ω—ã–π cover
    const r = stage.getBoundingClientRect();
    const g = layoutCoverForImg(r.width, r.height, naturalW, naturalH, pos);
    Object.assign(imgMain.style, {
      width: g.w + 'px', height: g.h + 'px',
      left: g.left + 'px', top: g.top + 'px', opacity:'1'
    });
    // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –¥–ª—è –ª—É–ø—ã
    lensCv.dataset.w = g.w; 
    lensCv.dataset.h = g.h; 
    lensCv.dataset.left = g.left; 
    lensCv.dataset.top  = g.top;
  };
}

/* ===== –°–¢–ê–†–¢ ===== */
startBtn.onclick=()=>{
  document.body.classList.remove('prestart');
  document.body.classList.add('started');

  const total = GAME_CONFIG.levels.length;
  state.score = 0;
  for(let i=0;i<total;i++) if(localStorage.getItem(`level_done_${i}`)==='1') state.score += 100;
  scoreEl.textContent = state.score;

  let saved = parseInt(localStorage.getItem('current_level') || '0', 10);
  if (!Number.isFinite(saved) || saved < 0) saved = 0;
  if (saved >= total) saved = 0;
  startLevel(saved);
};

/* ===== –ó–ê–ü–£–°–ö –£–†–û–í–ù–Ø ===== */
async function startLevel(i){
  currentLevel = i;
  state.found = false; state.taskDone = false;
  sidePanel.style.display = 'none';
  levelTask.hidden = false;
  nextBtn.setAttribute('aria-disabled','true');
  updateHud();

  localStorage.setItem('current_level', i);

  const L = GAME_CONFIG.levels[i];

  const seq = ++loadSeq;
  showLoader(seq);
  const {src,width,height} = await preload(L.bg);
  if (seq !== loadSeq) return;
  naturalW = width; naturalH = height;
  setImage(src, L.bgPos || 'center');
  if (L.bgFound) preload(L.bgFound);
  hideLoader(seq);

  levelTask.textContent = '–ù–∞–π–¥–∏ –®–∞–≥—É–Ω—é –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ';

  stage.onclick = (e) => {
    if(state.found) return;
    const pt = clickPt(e);
    if(e.shiftKey) console.log(`x:${pt.x.toFixed(2)} y:${pt.y.toFixed(2)}`);

    let hit=false;
    if(L.poly) hit = pointInPoly(pt, L.poly);
    else if(L.hotspot) hit = inside(pt, L.hotspot);

    if(hit) onFound(L, i);
    else showToast('–ù–µ –∑–¥–µ—Å—å üòä');
  };
}

/* ===== –ù–ê–ô–î–ï–ù–û ===== */
async function onFound(L, idx){
  state.found = true;

  const seq = ++loadSeq;
  showLoader(seq);
  const found = await preload(L.bgFound);
  if (seq !== loadSeq) return;
  naturalW = found.width; naturalH = found.height;
  setImage(found.src, L.bgFoundPos || 'center');
  hideLoader(seq);

  sidePanel.querySelector('h3').textContent = L.introTitle;
  sidePanel.querySelector('p').textContent  = L.introText;
  hintText.innerHTML = L.taskText;
  reportOptions.innerHTML = L.options.map(([v,label]) =>
    `<label><input type="radio" name="task" value="${v}"> ${label}</label><br/>`
  ).join('');

  levelTask.hidden = true;
  sidePanel.style.display = 'block';

  celebrate.style.display='grid';
  const h=celebrate.firstElementChild; h.style.animation='none'; void h.offsetWidth; h.style.animation='';
  setTimeout(()=>celebrate.style.display='none',1200);

  const last = GAME_CONFIG.levels.length - 1;
  nextBtn.style.display = (idx === last) ? 'none' : 'inline-block';
}

/* ===== –û–¢–ß–Å–¢ ===== */
reportBtn.onclick = () => reportModal.style.display = 'grid';
cancelReport.onclick = () => reportModal.style.display = 'none';
submitReport.onclick = () => {
  const sel = document.querySelector('input[name="task"]:checked');
  if(!sel){ showToast('–í—ã–±–µ—Ä–∏, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—à—å üôÇ'); return; }
  state.taskDone = true;

  if(localStorage.getItem(`level_done_${currentLevel}`)!=='1'){
    localStorage.setItem(`level_done_${currentLevel}`,'1');
    state.score += 100; scoreEl.textContent = state.score;
  }
  localStorage.setItem('current_level', currentLevel + 1);

  reportModal.style.display = 'none';
  nextBtn.removeAttribute('aria-disabled');
  showToast(currentLevel === GAME_CONFIG.levels.length-1 ? '–§–∏–Ω–∞–ª –ø—Ä–æ–π–¥–µ–Ω! ‚ú®' : '–û—Ç–ª–∏—á–Ω–æ! –£—Ä–æ–≤–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω ‚úÖ',1800);
  updateHud();
};

/* ===== –°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨ ===== */
nextBtn.onclick = () => {
  if(!state.taskDone){ showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ –æ—Ç –®–∞–≥—É–Ω–∏ üôÉ', 2000); return; }
  const last = GAME_CONFIG.levels.length - 1;
  if(currentLevel < last) startLevel(currentLevel + 1);
  else showToast('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! üéâ',2200);
};

/* ===== –õ–£–ü–ê (canvas, pixel-perfect, edge-safe) ===== */
let zoomOn=false;

// –¢–µ–∫—É—â–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è –æ—Ç–æ–±—Ä–∞–∂—ë–Ω–Ω–æ–≥–æ IMG
function currentImgGeom(){
  return {
    w: parseFloat(lensCv.dataset.w || imgMain.width),
    h: parseFloat(lensCv.dataset.h || imgMain.height),
    left: parseFloat(lensCv.dataset.left || imgMain.offsetLeft),
    top:  parseFloat(lensCv.dataset.top  || imgMain.offsetTop)
  };
}
function syncLensGeomFromImg(){
  const r = stage.getBoundingClientRect();
  const g = layoutCoverForImg(r.width, r.height, naturalW, naturalH, currentBgPos);
  Object.assign(imgMain.style, { width:g.w+'px', height:g.h+'px', left:g.left+'px', top:g.top+'px' });
  lensCv.dataset.w=g.w; lensCv.dataset.h=g.h; lensCv.dataset.left=g.left; lensCv.dataset.top=g.top;
}

// –†–∏—Å—É–µ–º –ª—É–ø—É —Å –∫–ª–∞–º–ø–æ–º —Ç–∞–∫, —á—Ç–æ–±—ã –í–ï–°–¨ –∫—Ä—É–≥ –±—ã–ª –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
function drawLensAt(clientX, clientY){
  if(!zoomOn) return;

  const stageRect = stage.getBoundingClientRect();
  // –ë–∞–∑–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω—ã
  let x = Math.max(stageRect.left, Math.min(stageRect.right, clientX)) - stageRect.left;
  let y = Math.max(stageRect.top,  Math.min(stageRect.bottom, clientY)) - stageRect.top;

  // –ì–µ–æ–º–µ—Ç—Ä–∏—è IMG (–∫–∞–∫ –æ–Ω —É–ª–æ–∂–µ–Ω –ø–æ cover)
  const g = currentImgGeom();

  // –ü–µ—Ä–µ—Å—á—ë—Ç –º–∞—Å—à—Ç–∞–±–∞: —Å–∫–æ–ª—å–∫–æ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ 1px —Å—Ü–µ–Ω—ã
  const pxPerStageX = naturalW / g.w;
  const pxPerStageY = naturalH / g.h;

  // –†–∞–∑–º–µ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö), –∫–æ—Ç–æ—Ä—ã–π —É–≤–µ–ª–∏—á–∏–º –¥–æ –¥–∏–∞–º–µ—Ç—Ä–∞ –ª—É–ø—ã
  const srcW = (LENS_D / ZOOM) * pxPerStageX;
  const srcH = (LENS_D / ZOOM) * pxPerStageY;

  // ---- EDGE-SAFE –ö–õ–ê–ú–ü –ü–û –ö–û–û–†–î–ò–ù–ê–¢–ï –ö–£–†–°–û–†–ê ----
  // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (—Ü–µ–Ω—Ç—Ä –≤ imgPX,imgPY, —Ä–∞–∑–º–µ—Ä srcW x srcH) –¥–æ–ª–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–µ–∂–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
  // –ò–∑ —ç—Ç–æ–≥–æ –≤—ã–≤–æ–¥–∏–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç nx,ny (0..1).
  const nxMin = (srcW/2) / naturalW;
  const nxMax = 1 - nxMin;
  const nyMin = (srcH/2) / naturalH;
  const nyMax = 1 - nyMin;

  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å—Ü–µ–Ω—ã (px)
  const xMinStage = g.left + nxMin * g.w;
  const xMaxStage = g.left + nxMax * g.w;
  const yMinStage = g.top  + nyMin * g.h;
  const yMaxStage = g.top  + nyMax * g.h;

  // –ö–ª–∞–º–ø–∏–º –∫—É—Ä—Å–æ—Ä (—Ü–µ–Ω—Ç—Ä –ª—É–ø—ã) —Ç–∞–∫, —á—Ç–æ–±—ã –∫—Ä—É–≥ –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
  x = Math.max(xMinStage, Math.min(xMaxStage, x));
  y = Math.max(yMinStage, Math.min(yMaxStage, y));
  // -----------------------------------------------

  // –ü–æ–∑–∏—Ü–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ª—É–ø—ã (—á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä —Å–æ–≤–ø–∞–¥–∞–ª —Å (x,y))
  const lx = x - LENS_R;
  const ly = y - LENS_R;
  lensCv.style.transform = `translate(${lx}px, ${ly}px)`;

  // –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–∏–º–æ–≥–æ IMG (0..1)
  const nx = (x - g.left) / g.w;
  const ny = (y - g.top)  / g.h;

  // –¶–µ–Ω—Ç—Ä –≤—ã—Ä–µ–∑–∞ –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö
  const imgPX = nx * naturalW;
  const imgPY = ny * naturalH;

  // –ò—Ç–æ–≥–æ–≤—ã–µ —É–≥–ª—ã –≤—ã—Ä–µ–∑–∞ (–∏—Å—Ö–æ–¥–Ω–∏–∫) —É–∂–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏ (–±–ª–∞–≥–æ–¥–∞—Ä—è –∫–ª–∞–º–ø—É)
  const sx = imgPX - srcW/2;
  const sy = imgPY - srcH/2;

  // –†–µ–Ω–¥–µ—Ä –≤ –∫–∞–Ω–≤–∞—Å-–ª—É–ø—É
  lctx.clearRect(0,0,LENS_D,LENS_D);
  lctx.save();
  lctx.beginPath();
  lctx.arc(LENS_R, LENS_R, LENS_R-1.5, 0, Math.PI*2);
  lctx.closePath();
  lctx.clip();
  lctx.imageSmoothingEnabled = true;
  lctx.drawImage(imgMain, sx, sy, srcW, srcH, 0, 0, LENS_D, LENS_D);
  lctx.restore();

  // –†–∞–º–∫–∞
  lctx.beginPath();
  lctx.arc(LENS_R, LENS_R, LENS_R-1.5, 0, Math.PI*2);
  lctx.strokeStyle = 'rgba(0,0,0,.28)';
  lctx.lineWidth = 3;
  lctx.stroke();
}

zoomBtn.addEventListener('click', ()=>{
  zoomOn = !zoomOn;
  zoomBtn.setAttribute('aria-pressed', String(zoomOn));
  lensCv.style.display = zoomOn ? 'block' : 'none';
  if(zoomOn){
    const r = stage.getBoundingClientRect();
    drawLensAt(r.left + r.width/2, r.top + r.height/2);
  }
});

// –ú—ã—à—å/—Ç–∞—á
stage.addEventListener('mousemove', e=>{ if(zoomOn) drawLensAt(e.clientX, e.clientY); });
stage.addEventListener('mouseleave', ()=>{ if(zoomOn) lensCv.style.display='none'; });
stage.addEventListener('mouseenter', ()=>{ if(zoomOn) lensCv.style.display='block'; });
stage.addEventListener('touchstart', e=>{ if(!zoomOn) return; const t=e.touches[0]; lensCv.style.display='block'; drawLensAt(t.clientX,t.clientY); }, {passive:true});
stage.addEventListener('touchmove',  e=>{ if(!zoomOn) return; const t=e.touches[0]; drawLensAt(t.clientX,t.clientY); }, {passive:true});

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é IMG –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ª—É–ø–æ–π
window.addEventListener('resize', ()=>{
  if(!currentSrc) return;
  syncLensGeomFromImg();
  const r = stage.getBoundingClientRect();
  if(zoomOn) drawLensAt(r.left + r.width/2, r.top + r.height/2);
});
</script>
</body>
</html>
