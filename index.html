<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>–®–ê–ì–ê–ô –î–û–ú–ê ‚Äî –ù–∞–π–¥–∏ –ü—Ä–∏–≤–∏–¥–µ–Ω–∏–µ –û—Å–µ–Ω–Ω–µ–≥–æ –õ–∞–≥–µ—Ä—è</title>
<style>
:root{ --page:#fff; --text:#222428; --brand:#e24a27; --panel:#f6f7f8; --shadow:rgba(0,0,0,.10) }
html,body{height:100%}
body{margin:0;background:var(--page);color:var(--text);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
[hidden]{display:none!important}

/* —Å–æ—Å—Ç–æ—è–Ω–∏—è */
body.prestart #hud, body.prestart #gameWrap{display:none!important}
body.started  #introWrap{display:none!important}

/* –∏–Ω—Ç—Ä–æ */
.intro-wrap{max-width:1280px;margin:16px auto;padding:0 12px}
.intro{position:relative;display:grid;place-items:center;overflow:hidden;border-radius:18px;background:#eff1f3;min-height:52vh;max-height:78vh;box-shadow:0 16px 40px rgba(0,0,0,.10);border:1px solid rgba(0,0,0,.06)}
.intro figure{position:absolute;inset:0;margin:0}
.intro img{width:100%;height:100%;object-fit:cover;display:block;filter:brightness(.9) saturate(1.02);opacity:0;transition:opacity .35s}
.intro img.ready{opacity:1}
.intro::after{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(70% 60% at 50% 50%,rgba(0,0,0,.06)0%,rgba(0,0,0,.22)100%)}

/* –ü–ê–ù–ï–õ–¨ ‚Äî ¬´—Å—Ç–µ–∫–ª–æ¬ª + –±–ª–µ—Å–∫ */
.intro .panel{
  position:relative;z-index:1;width:min(740px,92vw);
  background:linear-gradient(180deg,rgba(255,255,255,.86),rgba(255,255,255,.72));
  color:#202226;border:1px solid rgba(0,0,0,.08);border-radius:14px;
  padding:14px 14px 12px;box-shadow:0 18px 44px rgba(0,0,0,.16);
  backdrop-filter:blur(8px);overflow:hidden;
}
.intro .panel::after{
  content:"";position:absolute;inset:-40% -20% auto -20%;height:200%;
  background:linear-gradient(70deg,transparent 40%,rgba(255,255,255,.45) 50%,transparent 60%);
  transform:translateX(-120%) rotate(8deg);
  animation:panelShine 7s ease-in-out 1.2s infinite;pointer-events:none;mix-blend-mode:screen;
}
@keyframes panelShine{0%,85%{transform:translateX(-120%) rotate(8deg)}100%{transform:translateX(120%) rotate(8deg)}}

.intro h1{margin:0 0 6px;letter-spacing:.2px;font-size:clamp(20px,2vw + 11px,26px);line-height:1.15;
  text-shadow:0 1px 0 #fff, 0 10px 24px rgba(226,74,39,.12)}
.intro p{margin:8px 0 0}
.intro blockquote{margin:10px 0;padding:10px 12px;background:#fff;border-radius:12px;border:1px solid rgba(0,0,0,.06);position:relative;font-size:.97em;line-height:1.35}
.intro blockquote::before{content:"‚Äú";position:absolute;left:8px;top:-12px;font-size:28px;color:var(--brand);opacity:.85;line-height:1}

/* –∫–Ω–æ–ø–∫–∏ */
.btn{cursor:pointer;border:0;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;padding:10px 14px;box-shadow:0 6px 18px rgba(226,74,39,.25);
  transition: transform .15s ease, box-shadow .2s ease}
.btn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(226,74,39,.35) }
.btn:active{ transform:translateY(0) scale(.98) }
@media (prefers-reduced-motion:no-preference){
  .btn{ animation:pulse 2.4s ease-in-out 1.2s infinite }
}
@keyframes pulse{0%,100%{box-shadow:0 6px 18px rgba(226,74,39,.25)}50%{box-shadow:0 10px 26px rgba(226,74,39,.38)}}

/* –ø–∞–¥–∞—é—â–∏–µ –ª–∏—Å—Ç–æ—á–∫–∏ */
.leaves{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.leaf{position:absolute;top:-10%;font-size:clamp(16px,2.2vw,24px);opacity:.85;filter:drop-shadow(0 6px 6px rgba(0,0,0,.15));
  animation:fall var(--t,11s) linear var(--d,0s) infinite;transform:translateX(0) rotate(var(--r,0deg))}
.leaf[data-t="1"]::before{content:"üçÅ"} .leaf[data-t="2"]::before{content:"üçÇ"} .leaf[data-t="3"]::before{content:"üçÉ"}
@keyframes fall{
  0%{transform:translateX(0) translateY(-10%) rotate(0deg);opacity:.95}
  25%{transform:translateX(-6vw) translateY(25vh) rotate(60deg)}
  50%{transform:translateX(5vw) translateY(50vh) rotate(140deg)}
  75%{transform:translateX(-4vw) translateY(75vh) rotate(220deg)}
  100%{transform:translateX(6vw) translateY(110vh) rotate(300deg);opacity:.9}
}

@media (max-width:560px){
  .intro{min-height:50vh;max-height:72vh;border-radius:16px}
  .intro .panel{width:calc(100% - 18px);padding:12px;border-radius:12px;max-height:58vh;overflow:auto;-webkit-overflow-scrolling:touch}
  .intro h1{font-size:clamp(18px,5vw,21px);margin-bottom:4px}
  .intro p,.intro blockquote{font-size:15px}
  .intro blockquote{padding:8px 10px}
  .intro blockquote::before{font-size:24px;top:-9px}
}

/* HUD */
.hud{position:sticky;top:0;display:flex;gap:10px;align-items:center;padding:10px 14px;background:linear-gradient(180deg,#fff,rgba(255,255,255,.86));z-index:5;border-bottom:1px solid rgba(0,0,0,.06)}
.badge{display:inline-flex;gap:8px;align-items:center;background:#fff;padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.06)}
.brand{color:var(--brand);font-weight:700}
.progress{flex:1;height:8px;background:#eceff1;border-radius:999px;overflow:hidden}
.bar{height:100%;width:0;background:var(--brand);transition:width .35s ease}
.pill{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 14px;color:#444}

/* –∏–≥—Ä–∞ */
.play-wrap{max-width:1200px;margin:10px auto 24px;padding:0 12px;display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
.stage-wrap{position:relative;flex:1 1 680px;min-width:320px;aspect-ratio:16/10}
.stage{position:relative;width:100%;height:100%;overflow:hidden;border-radius:16px;background:#ddd center/cover no-repeat;box-shadow:0 12px 36px var(--shadow);border:1px solid rgba(0,0,0,.06)}
.layer{position:absolute;inset:0}
#bg{transition:opacity .25s ease}
.dock{width:100%;display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}

/* –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ / —Å–Ω–∏–∑—É */
.side{flex:0 0 min(380px,34vw);background:var(--panel);border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:16px;box-shadow:0 10px 24px var(--shadow);display:none}
.side h3{margin:6px 0 8px}
.side .hint{margin:10px 0 0;background:#fff;border:1px dashed rgba(0,0,0,.2);border-radius:10px;padding:10px 12px}
.side .btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
@media (max-width:720px){ .side{flex:1 1 100%} }

/* —Å–∏—Å—Ç–µ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.loader{position:absolute;inset:0;display:grid;place-items:center;background:rgba(255,255,255,.35);z-index:4}
.ring{width:42px;height:42px;border-radius:50%;border:4px solid rgba(0,0,0,.12);border-top-color:var(--brand);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);z-index:15;padding:16px}
.card{width:min(520px,92vw);background:#fff;color:#222;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:16px;box-shadow:0 16px 40px var(--shadow)}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* —Å–µ—Ä–¥–µ—á–∫–æ */
.celebrate{position:absolute;inset:0;display:none;place-items:center;pointer-events:none}
.heart{font-size:64px;opacity:0;transform:scale(.7);animation:pop 1.2s ease forwards}
@keyframes pop{0%{opacity:0;transform:scale(.7) translateY(20px)}50%{opacity:1;transform:scale(1) translateY(-4px)}100%{opacity:0;transform:scale(1.15) translateY(-24px)}}
</style>
</head>
<body class="prestart">

<!-- –ò–Ω—Ç—Ä–æ -->
<div class="intro-wrap" id="introWrap">
  <section id="intro" class="intro">
    <figure><img id="introImg" alt="–û—Å–µ–Ω–Ω–∏–π –ª–µ—Å"></figure>
    <!-- –õ–∏—Å—Ç–æ—á–∫–∏ -->
    <div class="leaves" aria-hidden="true"></div>

    <div class="panel">
      <h1>–û—Å–µ–Ω–Ω–∏–π –ª–∞–≥–µ—Ä—å ¬´–®–ê–ì–ê–ô –î–û–ú–ê¬ª</h1>
      <p>–í –ª–∞–≥–µ—Ä–µ –®–ê–ì–ê–ô –î–û–ú–ê –æ—Å–µ–Ω—å—é –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á—É–¥–µ—Å–∞. –û–¥–Ω–∞–∂–¥—ã –≤ —á–∞—Ç –ø—Ä–∏—à–ª–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:</p>
      <blockquote>¬´–ü—Ä–∏–≤–µ—Ç! –Ø –∂–∏–≤—É –∑–¥–µ—Å—å —Å –ø—Ä–æ—à–ª–æ–≥–æ —Å–µ–∑–æ–Ω–∞. –Ø –ª—é–±–ª—é —á–∞–π —Å –æ–±–ª–µ–ø–∏—Ö–æ–π, –æ—Å–µ–Ω–Ω–∏–µ –ª–∏—Å—Ç—å—è –∏ —à–∞–≥–∏ –ø–æ —É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–æ—Å–µ. –ê –µ—â—ë —è –Ω–µ–º–Ω–æ–∂–∫–æ‚Ä¶ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π.¬ª</blockquote>
      <p>–¢–∞–∫ –≤—Å–µ —É–∑–Ω–∞–ª–∏ –ø—Ä–æ –ü—Ä–∏–≤–∏–¥–µ–Ω–∏–µ –û—Å–µ–Ω–Ω–µ–≥–æ –õ–∞–≥–µ—Ä—è ‚Äî –®–∞–≥—É–Ω—é. –û–Ω –Ω–µ –ø—É–≥–∞–µ—Ç, –∞ –ø–æ–º–æ–≥–∞–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è, –≥—Ä–µ—Ç—å—Å—è –∏ –Ω–µ –≥—Ä—É—Å—Ç–∏—Ç—å. –ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è: –∑–∞ –Ω–µ–¥–µ–ª—é –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –®–∞–≥—É–Ω—é –Ω–∞ –≤—Å–µ—Ö –ª–æ–∫–∞—Ü–∏—è—Ö –ª–∞–≥–µ—Ä—è –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ–≥–æ –∑–∞–¥–∞–Ω–∏—è.</p>
      <footer style="margin-top:10px"><button id="startBtn" class="btn" type="button">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button></footer>
    </div>
  </section>
</div>

<!-- HUD -->
<header class="hud" id="hud">
  <div class="badge">–£—Ä–æ–≤–µ–Ω—å: <span id="levelLabel" class="brand">1/1</span></div>
  <div class="progress"><div id="progressBar" class="bar"></div></div>
  <button id="hintBtn" class="btn" type="button" hidden>–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
</header>

<!-- –ò–≥—Ä–∞ -->
<section class="play-wrap" id="gameWrap">
  <div class="stage-wrap">
    <div id="stage" class="stage">
      <div id="bg" class="layer"></div>
      <div id="celebrate" class="celebrate"><div class="heart">üíñ</div></div>
      <div id="loader" class="loader" hidden><div class="ring"></div></div>
      <div id="err" class="layer" style="display:none;place-items:center;color:#b00020;font-weight:600;background:rgba(255,255,255,.7)">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è</div>
    </div>
    <div class="dock">
      <div id="levelTask" class="pill">–ù–∞–π–¥–∏ –®–∞–≥—É–Ω—é –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ</div>
      <div class="pill">–û—á–∫–∏: <span id="score">0</span></div>
    </div>
  </div>

  <aside id="sidePanel" class="side">
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è 1 —É—Ä–æ–≤–Ω—è ‚Äî –∫–∞–∫ –≤ —Ç–≤–æ—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ -->
    <h3>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!</h3>
    <p>–ü–æ—Ä–∞ —Ä–∞–∑–æ–≥–Ω–∞—Ç—å —Å–æ–Ω. –Ø –ª—é–±–ª—é –Ω–∞—á–∏–Ω–∞—Ç—å –¥–µ–Ω—å —Å –ª—ë–≥–∫–∏—Ö —à–∞–≥–æ–≤ ‚Äî –∞ —Ç—ã?</p>
    <div class="hint">
      <div id="hintText">üéØ <b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ø—Ä–æ–π—Ç–∏ 300 —à–∞–≥–æ–≤ –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.</div>
      <div style="margin-top:6px;">üïí –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è.</div>
    </div>
    <div class="btns">
      <button class="btn" id="reportBtn" type="button">–û—Ç—á–∏—Ç–∞—Ç—å—Å—è</button>
      <button class="btn" id="nextBtn" type="button" aria-disabled="true" style="background:#26a269">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    </div>
  </aside>
</section>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ç—á—ë—Ç–∞ -->
<section id="reportModal" class="modal">
  <div class="card">
    <h4>–û—Ç—á—ë—Ç –ø–æ –∑–∞–¥–∞–Ω–∏—é</h4>
    <div id="reportOptions">
      <!-- –î–ª—è —É—Ä–æ–≤–Ω—è 1 -->
      <label><input type="radio" name="task" value="steps300"> –Ø –ø—Ä–æ—à—ë–ª(–ª–∞) 300 —à–∞–≥–æ–≤</label><br/>
      <label><input type="radio" name="task" value="warmup2m"> –Ø —Å–¥–µ–ª–∞–ª(–∞) –∑–∞—Ä—è–¥–∫—É 2 –º–∏–Ω—É—Ç—ã</label>
    </div>
    <div class="actions">
      <button class="btn" id="cancelReport" type="button" style="background:#e7eaee;color:#222;box-shadow:none">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="submitReport" type="button">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>
</section>

<div id="toast" class="toast"></div>

<script>
/* === –ê–°–°–ï–¢–´ (–¥–æ–±–∞–≤–ª–µ–Ω—ã lvl2/lvl2found) === */
const ASSETS = {
  start:'start.jpg',
  lvl1:'lvl1.jpg',       lvl1found:'lvl1found.jpg',
  lvl2:'lvl2.jpg',       lvl2found:'lvl2found.jpg'
};

/* === –ö–û–ù–§–ò–ì –£–†–û–í–ù–ï–ô: 1 ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π; 2 ‚Äî –∫–∞–∫–∞–æ –∏ –∑–∞–¥–∞–Ω–∏–µ === */
const GAME_CONFIG = {
  levels: [
    {
      bg: ASSETS.lvl1,
      bgPos: 'center center',
      bgFound: ASSETS.lvl1found,
      bgFoundPos: 'center 60%',
      hotspot: { x: 97.25, y: 53.8, w: 3.4, h: 11.5 },
      hint: null,
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏–µ: –ø—Ä–æ–π—Ç–∏ 300 —à–∞–≥–æ–≤ –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.'
    },
    {
      bg: ASSETS.lvl2,
      bgPos: 'center center',
      bgFound: ASSETS.lvl2found,
      bgFoundPos: 'center center',
      hotspot: { x: 80, y: 70, w: 5, h: 9 },
      hint: null,
      introTitle: '–ì–æ—Ä—è—á–∏–π –∫–∞–∫–∞–æ',
      introText: '–ì–æ—Ä—è—á–∏–π –∫–∞–∫–∞–æ –∏ –¥–µ–Ω—å —É–∂–µ —á—É—Ç—å-—á—É—Ç—å –ª—É—á—à–µ! –ê —á—Ç–æ–±—ã –æ–Ω —Å—Ç–∞–ª —Å–æ–≤—Å–µ–º –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ —à–∞–≥–æ–≤',
      taskText: 'üéØ –ó–∞–¥–∞–Ω–∏–µ: —Å–¥–µ–ª–∞—Ç—å 500 —à–∞–≥–æ–≤ –ø–æ–¥ –º—É–∑—ã–∫—É –∏–ª–∏ –ø–æ—à–∞–≥–∞—Ç—å –Ω–∞ –º–µ—Å—Ç–µ 1 –º–∏–Ω—É—Ç—É.'
    }
  ]
};

/* === DOM === */
const $=s=>document.querySelector(s);
const introImg=$('#introImg'), startBtn=$('#startBtn'), stage=$('#stage'), bgLayer=$('#bg'),
      loader=$('#loader'), errLayer=$('#err'), sidePanel=$('#sidePanel'),
      hintBtn=$('#hintBtn'), scoreEl=$('#score'), toast=$('#toast'),
      nextBtn=$('#nextBtn'), reportBtn=$('#reportBtn'), celebrate=$('#celebrate'),
      levelTask=$('#levelTask'), levelLabel=$('#levelLabel'), progressBar=$('#progressBar'),
      hintText=$('#hintText'), reportOptions=$('#reportOptions');

/* === –°–û–°–¢–û–Ø–ù–ò–ï === */
let state={score:0,found:false,taskDone:false};
let currentLevel=0;

/* === –£–¢–ò–õ–ò–¢–´ === */
function preload(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(src);i.onerror=()=>rej(src);i.src=src;});}
function setBgSmart(url,pos){bgLayer.style.opacity='0';setTimeout(()=>{bgLayer.style.backgroundImage=`url('${url}')`;bgLayer.style.backgroundPosition=pos||'center center';bgLayer.style.backgroundSize='cover';bgLayer.style.opacity='1';},80);}
function showToast(msg,t=1600){toast.textContent=msg;toast.style.display='block';clearTimeout(showToast.tid);showToast.tid=setTimeout(()=>toast.style.display='none',t);}
function clickToPercent(e){const r=stage.getBoundingClientRect();return {x:(e.clientX-r.left)/r.width*100,y:(e.clientY-r.top)/r.height*100};}
function pointInRect(pt,r){return pt.x>=r.x-r.w/2 && pt.x<=r.x+r.w/2 && pt.y>=r.y-r.h/2 && pt.y<=r.y+r.h/2;}
function showLoader(){loader.hidden=false;loader.style.display='grid';}
function hideLoader(){loader.hidden=true;loader.style.display='none';}
function updateHud(){
  const total = GAME_CONFIG.levels.length;
  levelLabel.textContent = `${currentLevel+1}/${total}`;
  const doneCount = [...Array(total).keys()].filter(i => localStorage.getItem(`level_done_${i}`)==='1').length;
  const progress = Math.round((doneCount/total)*100);
  progressBar.style.width = progress + '%';
}

/* === –ò–ù–¢–†–û –§–û–ù === */
preload(ASSETS.start).then(src=>{introImg.src=src;introImg.onload=()=>introImg.classList.add('ready');}).catch(()=>introImg.remove());

/* === –°–¢–ê–†–¢ === */
startBtn.onclick=()=>{
  // –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –Ω–∏–∂–µ
  document.body.classList.remove('prestart');
  document.body.classList.add('started');
  startLevel(0);
};

/* === –ó–ê–ü–£–°–ö –£–†–û–í–ù–Ø === */
async function startLevel(i){
  currentLevel = i;
  state={score:state.score,found:false,taskDone:false};
  sidePanel.style.display='none';
  levelTask.hidden=false;
  nextBtn.setAttribute('aria-disabled','true');
  errLayer.style.display='none';
  updateHud();

  const L=GAME_CONFIG.levels[i];
  hintBtn.hidden=!L.hint;

  showLoader();
  try{
    const src=await preload(L.bg);
    setBgSmart(src,L.bgPos);
    if(L.bgFound) preload(L.bgFound);
  }catch(e){
    errLayer.style.display='grid';
  }finally{
    hideLoader();
  }

  levelTask.textContent='–ù–∞–π–¥–∏ –®–∞–≥—É–Ω—é –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ';

  stage.onclick=e=>{
    if(state.found) return;
    if(e.shiftKey){
      const p=clickToPercent(e);
      console.log(`Click @ x:${p.x.toFixed(2)} y:${p.y.toFixed(2)}`);
    }
    const pt=clickToPercent(e);
    if(L.hotspot && pointInRect(pt,L.hotspot)) onFound(L,i);
    else showToast('–ù–µ –∑–¥–µ—Å—å üòä –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë!');
  };
}

/* === –ù–ê–ô–î–ï–ù–û === */
function onFound(L, idx){
  state.found=true;
  showLoader();
  setBgSmart(L.bgFound,L.bgFoundPos);
  setTimeout(hideLoader,300);

  // –≥–æ—Ç–æ–≤–∏–º –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å
  const titleEl = sidePanel.querySelector('h3');
  const paraEl  = sidePanel.querySelector('p');

  if(idx===0){
    // –£—Ä–æ–≤–µ–Ω—å 1 ‚Äî —Ç–µ–∫—Å—Ç—ã –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
    if(hintText) hintText.innerHTML = 'üéØ <b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ø—Ä–æ–π—Ç–∏ 300 —à–∞–≥–æ–≤ –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.';
  } else if(idx===1){
    // –£—Ä–æ–≤–µ–Ω—å 2 ‚Äî —Ç–µ–∫—Å—Ç—ã –ø–æ –¢–ó
    if(titleEl) titleEl.textContent = '–ì–æ—Ä—è—á–∏–π –∫–∞–∫–∞–æ';
    if(paraEl)  paraEl.textContent  = '–ì–æ—Ä—è—á–∏–π –∫–∞–∫–∞–æ –∏ –¥–µ–Ω—å —É–∂–µ —á—É—Ç—å-—á—É—Ç—å –ª—É—á—à–µ! –ê —á—Ç–æ–±—ã –æ–Ω —Å—Ç–∞–ª —Å–æ–≤—Å–µ–º –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ —à–∞–≥–æ–≤';
    if(hintText) hintText.innerHTML = 'üéØ <b>–ó–∞–¥–∞–Ω–∏–µ:</b> —Å–¥–µ–ª–∞—Ç—å 500 —à–∞–≥–æ–≤ –ø–æ–¥ –º—É–∑—ã–∫—É –∏–ª–∏ –ø–æ—à–∞–≥–∞—Ç—å –Ω–∞ –º–µ—Å—Ç–µ 1 –º–∏–Ω—É—Ç—É.';
  }

  // –æ–ø—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞
  if(idx===0){
    reportOptions.innerHTML = `
      <label><input type="radio" name="task" value="steps300"> –Ø –ø—Ä–æ—à—ë–ª(–ª–∞) 300 —à–∞–≥–æ–≤</label><br/>
      <label><input type="radio" name="task" value="warmup2m"> –Ø —Å–¥–µ–ª–∞–ª(–∞) –∑–∞—Ä—è–¥–∫—É 2 –º–∏–Ω—É—Ç—ã</label>
    `;
  } else if(idx===1){
    reportOptions.innerHTML = `
      <label><input type="radio" name="task" value="steps500"> –Ø —Å–¥–µ–ª–∞–ª(–∞) 500 —à–∞–≥–æ–≤ –ø–æ–¥ –º—É–∑—ã–∫—É</label><br/>
      <label><input type="radio" name="task" value="march1m"> –Ø –ø–æ—à–∞–≥–∞–ª(–∞) –Ω–∞ –º–µ—Å—Ç–µ 1 –º–∏–Ω—É—Ç—É</label>
    `;
  }

  hintBtn.hidden=true;
  levelTask.hidden=true;
  sidePanel.style.display='block';

  if(localStorage.getItem(`level_done_${idx}`)!=='1'){
    state.score+=100;
    scoreEl.textContent=state.score;
  }
}

/* === –û–¢–ß–Å–¢ === */
const reportModal=$('#reportModal'), cancelReport=$('#cancelReport'), submitReport=$('#submitReport');
reportBtn.onclick=()=>reportModal.style.display='grid';
cancelReport.onclick=()=>reportModal.style.display='none';
submitReport.onclick=()=>{
  const done=document.querySelector('input[name="task"]:checked');
  if(!done){showToast('–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è üôÇ');return;}
  state.taskDone=true;
  localStorage.setItem(`level_done_${currentLevel}`,'1');
  reportModal.style.display='none';
  nextBtn.removeAttribute('aria-disabled');

  celebrate.style.display='grid';
  const h=celebrate.firstElementChild;
  h.style.animation='none'; void h.offsetWidth; h.style.animation='';
  setTimeout(()=>celebrate.style.display='none',1200);

  showToast('–û—Ç–ª–∏—á–Ω–æ! –£—Ä–æ–≤–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω ‚úÖ',1800);
  updateHud();
};

/* === –°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨ === */
nextBtn.onclick=()=>{
  if(!state.taskDone){
    showToast('–û–π, –≤—ã –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –æ—Ç –®–∞–≥—É–Ω–∏ üôÉ',2200);
    return;
  }
  const last = GAME_CONFIG.levels.length - 1;
  if(currentLevel < last){
    startLevel(currentLevel + 1);
  }else{
    showToast('–í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! üéâ',2000);
  }
};
</script>

<!-- WOW-—ç—Ñ—Ñ–µ–∫—Ç—ã –∏–Ω—Ç—Ä–æ: –ø–∞—Ä–∞–ª–ª–∞–∫—Å, –ª–∏—Å—Ç—å—è, –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ -->
<script>
// –ü–∞—Ä–∞–ª–ª–∞–∫—Å —Ñ–æ–Ω–∞ –≤ –∏–Ω—Ç—Ä–æ
(() => {
  const img = document.getElementById('introImg');
  const intro = document.getElementById('intro');
  if(!img || !intro) return;
  let raf;
  function onMove(e){
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=> {
      const r = intro.getBoundingClientRect();
      const src = ('touches' in e && e.touches.length ? e.touches[0] : e);
      const cx = (src.clientX ?? (r.left + r.width/2)) - r.left;
      const cy = (src.clientY ?? (r.top  + r.height/2)) - r.top;
      const x = ((cx / r.width)  - .5) * 10;
      const y = ((cy / r.height) - .5) * 10;
      img.style.transform = `scale(1.05) translate(${x}px, ${y}px)`;
    });
  }
  intro.addEventListener('mousemove', onMove, {passive:true});
  intro.addEventListener('touchmove', onMove, {passive:true});
})();

// –ü–∞–¥–∞—é—â–∏–µ –ª–∏—Å—Ç–æ—á–∫–∏
(() => {
  const box = document.querySelector('.leaves');
  if(!box) return;
  const N = 14;
  for (let i=0;i<N;i++){
    const s = document.createElement('span');
    s.className = 'leaf';
    s.dataset.t = (i % 3) + 1;
    s.style.left = Math.random()*100 + 'vw';
    s.style.setProperty('--t', (9 + Math.random()*6) + 's');
    s.style.setProperty('--d', (Math.random()*5) + 's');
    s.style.setProperty('--r', (Math.random()*60 - 30) + 'deg');
    box.appendChild(s);
  }
})();

// –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª
(() => {
  const btn = document.getElementById('startBtn');
  if(!btn) return;
  btn.addEventListener('click', (e)=> {
    const burst = document.createElement('div');
    Object.assign(burst.style, {
      position:'fixed', left:(e.clientX||window.innerWidth/2)+'px',
      top:(e.clientY||window.innerHeight/2)+'px', pointerEvents:'none', zIndex:9999
    });
    document.body.appendChild(burst);
    const n=80;
    for(let i=0;i<n;i++){
      const d=document.createElement('i');
      const size = 4 + Math.random()*6;
      const ang = Math.random()*Math.PI*2;
      const vel = 3 + Math.random()*6;
      d.style.position='absolute';
      d.style.width=size+'px'; d.style.height=size+'px';
      d.style.background = ['#e24a27','#FFBA08','#E85D04','#D9D9D9','#ffffff'][i%5];
      d.style.borderRadius = (Math.random()>.5? '50%' : '2px');
      d.style.transform = 'translate(0,0)';
      d.style.opacity = '1';
      burst.appendChild(d);
      const tx = Math.cos(ang)*vel*20, ty = Math.sin(ang)*vel*18 - 10;
      d.animate([
        { transform:'translate(0,0) rotate(0deg)', opacity:1 },
        { transform:`translate(${tx/2}px, ${ty/2}px) rotate(180deg)`, opacity:1 },
        { transform:`translate(${tx}px, ${ty}px) rotate(360deg)`, opacity:0 }
      ], { duration: 900 + Math.random()*300, easing:'cubic-bezier(.2,.6,.2,1)', fill:'forwards' });
    }
    setTimeout(()=> burst.remove(), 1200);
  });
})();
</script>
</body>
</html>
